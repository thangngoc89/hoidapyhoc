function sticky(){width=parseInt($(window).width()),width>767&&$("#quiz-sidebar, #mainRow").stick_in_parent()}function resize_do(){width=parseInt($(window).width()),scrollTop=parseInt($(window).scrollTop()),width<=767&&(scrollTop>=100?$("#quiz-sidebar").addClass("quiz-side-fixed"):$("#quiz-sidebar").removeClass("quiz-side-fixed"))}function validationError(e){$.each(e,function(e,t){t.forEach(function(e){toastr.warning(e)})})}function preventClosing(){window.onbeforeunload=function(e){return e=e||window.event,global.preventClose?(e&&(e.returnValue="Bạn có chắc chắn muốn thoát ? "),"Bạn có chắc chắn muốn thoát ? "):void 0}}function pushState(e){history.pushState?history.pushState(null,null,e):location.hash=e}function quizDoInt(){handleTabs(),resize_do(),$(window).on("resize",function(){resize_do()}).on("scroll",function(){resize_do()}),$("#btnSheet").on("click",function(){$(".quiz-sidebar-section").slideToggle()}),$(".icontest-option").on("click",function(e){e.preventDefault(),toastr.info("Hãy nhấn bắt đầu để làm bài")}),$("#btnSubmit").on("click",function(){submitTest()}),$("#btnStart").on("click",function(){$(".icontest-option").off("click"),$("#quiz-content").removeClass("hide"),$("#quiz-rule").hide(),$("#btnSubmit").show(),$("#btnStart").hide(),sticky(),toastr.info("Bắt đầu làm bài thôi nào ^_^"),choiceDo(),setCounter(),global.preventClose=!0,preventClosing()})}function setCounter(){$.ajax({type:"POST",dataType:"json",url:"/api/v2/exams/"+testId+"/start",error:function(e){toastr.error(":( Đã có lỗi xảy ra. Mong các bạn hãy thử lại"),e=$.parseJSON(e.responseText),validationError(e),console.log(e)},success:function(e){userHistoryId=e.user_history_id,counter=setInterval(timer,1e3)}})}function timer(){if(count-=1,-1==count)return clearInterval(counter),void sendSubmitTest();var e=count%60,t=Math.floor(count/60),n=Math.floor(t/60);t%=60,n%=60,$(".timecou").html(n+":"+t+":"+e)}function submitTest(){swal({title:"Bạn có muốn nộp bài chứ?",type:"warning",showCancelButton:!0,confirmButtonClass:"btn-danger",confirmButtonText:"Có!",closeOnConfirm:!1},function(){sendSubmitTest()})}function sendSubmitTest(){$.ajax({type:"POST",dataType:"json",beforeSend:function(){$("#btnSubmit").button("loading")},url:$("#frmTest").attr("action"),data:{user_history_id:userHistoryId,test_id:testId,answers:gatherAnswer()},error:function(e){console.log(e.responseText),toastr.error("Có lỗi xảy ra. Vui lòng kiểm tra kĩ và thử lại"),$("#btnSubmit").button("reset")},success:function(e){global.preventClose=!1,swal({title:"Bạn làm đúng "+e.score+"/"+e.totalQuestion+" câu hỏi",text:"Bạn có muốn xem lại kết quả chi tiết chứ?",type:"success",showCancelButton:!0,confirmButtonClass:"btn-info",confirmButtonText:"Có chứ!",cancelButtonText:"Không, để làm lại!",closeOnConfirm:!0,closeOnCancel:!0},function(t){location.href=t?e.url:location.href})}})}function gatherAnswer(){var e=[];return $(".questionRow").each(function(){questionId=$(this).data("question-id"),questionOrder=$(this).data("question-order"),givenAnswer=$('input[id^="answer_'+questionOrder+'_"][value=1]').attr("name"),givenAnswer=givenAnswer?givenAnswer.substring(givenAnswer.length-1,givenAnswer.length):0,e.push(givenAnswer)}),e}function choiceDo(){$(".icontest-option").on("click",function(e){e.preventDefault(),questionId=$(this).data("question-id"),questionRow=$(this).parent().parent(),questionRow.alterClass("unanswered","answered"),questionOrder=questionRow.data("question-order");var t=$('a[id^="a_'+questionOrder+'_"]'),n=$('input[id^="answer_'+questionOrder+'_"]');t.each(function(){$(this).alterClass("op-*","op-"+$(this).html())}),n.each(function(){$(this).val(0)}),$(this).alterClass("op-*","op-choice"),$(this).siblings().val(1),updateAnswerCount()})}function updateAnswerCount(){answered=$("tr.answered").length,$("#answeredCount").html(answered),$(".userAnswerCount").attr("value",answered),totalAnswer=parseInt($("#totalAnswer").html()),answered>=totalAnswer/2&&$("#btnSubmit").attr("disabled",null)}function handleTabs(){var e=document.location.hash;e&&$(".lessons-nav__primary a[href="+e+"]").tab("show"),$(".lessons-nav__primary a").on("shown.bs.tab",function(e){pushState(e.target.hash),"#leaderBoard"==e.target.hash&&showLeaderBoard()})}function showLeaderBoard(){ele=$("div#leaderBoard"),ele.html().trim()||getRenderedLeaderBoard("/api/v2/exams/"+testId+"/leaderboard")}function getRenderedLeaderBoard(e){$.ajax({type:"GET",url:e,data:{render:!0},error:function(e){console.log(e.responseText),toastr.error("Không thể tải bảng điểm. Vui lòng thử lại sau")},success:function(e){ele.html(e),ajaxLoadPage()}})}function ajaxLoadPage(){$pagination=$("#leaderBoard > .forum-pagination a"),$pagination.unbind(),$pagination.on("click",function(e){e.preventDefault(),getRenderedLeaderBoard($(this).attr("href"))})}!function(e){e.fn.alterClass=function(t,n){var i=this;if(-1===t.indexOf("*"))return i.removeClass(t),n?i.addClass(n):i;var a=new RegExp("\\s"+t.replace(/\*/g,"[A-Za-z0-9-_]+").split(" ").join("\\s|\\s")+"\\s","g");return i.each(function(t,n){for(var i=" "+n.className+" ";a.test(i);)i=i.replace(a," ");n.className=e.trim(i)}),n?i.addClass(n):i}}(jQuery),$(function(){$.ajaxSetup({headers:{"X-XSRF-Token":$('meta[name="csrf"]').attr("content")}}),$("img").unveil(200),$("#q").selectize({valueField:"url",labelField:"name",searchField:["name"],maxOptions:10,options:[],create:!1,render:{option:function(e,t){return"<div>"+t(e.name)+"</div>"}},optgroups:[{value:"tag",label:"Tag"},{value:"exam",label:"Đề thi"},{value:"video",label:"Video"}],optgroupField:"group",optgroupOrder:["exam","tag"],load:function(e,t){return e.length?void $.ajax({url:"/api/v2/search",type:"GET",dataType:"json",data:{q:e},error:function(){t()},success:function(e){t(e.data)}}):t()},onChange:function(){window.location=this.items[0]}})}),toastr.options={closeButton:!1,debug:!1,progressBar:!1,positionClass:"toast-bottom-right",onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"5000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},function(e){function t(){$(),d(),c(),l(),e("#frmTest").on("submit",function(e){e.preventDefault(),a()}),sticky(),x(),v(),q()}function n(){test=global.data.test,_.name.val(test.name),_.description.val(test.description),_.content.html(test.content),_.begin.val(parseInt(test.beginFrom)),test.file&&(e('a[href="#upload"]').tab("show"),pdfFile={link:test.file.link,id:test.file.id},b(pdfFile)),test.tags&&_.tag.val(test.tags.join()),_.adjustTotal.hide(),T.postAjaxMethod="PUT",T.postUrl="/api/v2/exams/"+test.id,t()}function a(){data=s(),data&&e.ajax({type:T.postAjaxMethod,dataType:"json",url:T.postUrl,data:data,beforeSend:function(){_.btnCreateSubmit.button("loading")},error:function(t){_.btnCreateSubmit.button("reset"),toastr.error("Có lỗi xảy ra. Vui lòng kiểm tra kĩ và thử lại"),t=e.parseJSON(t.responseText),validationError(t),C(t)},success:function(e){o(e)}})}function o(e){swal({title:"Đã gửi đề thi thành công",text:"Làm gì tiếp theo?",type:"success",showCancelButton:!0,confirmButtonClass:"btn-info",confirmButtonText:"Xem đề thi",cancelButtonText:"Chỉnh sửa",closeOnConfirm:!0,closeOnCancel:!0},function(t){T.preventClose=!1,location.href=t?e.url:e.editUrl})}function s(){if(!m())return!1;if(name=e("#input-name").val(),description=e("#input-description").val(),content=e("#content").editable("getHTML"),begin=e("#begin").val(),begin=parseInt(begin)>=1?parseInt(begin):1,tags=e("#select-tags").val(),time=e("#select-time").val(),is_file=0,file_id=null,!name||name.length<6)return toastr.warning("Tên đề thi có độ dài tối thiểu là 6"),!1;if(description&&description.length<6)return toastr.warning("Mô tả có độ dài tối thiểu là 6"),!1;if(pdf_upload=e('a[role="tab"][aria-expanded="true"]').attr("href"),pdf_upload="#upload"==pdf_upload,pdf_upload){if(!global.pdf_file_id)return toastr.warning("Bạn chưa upload file pdf"),!1;is_file=1,file_id=global.pdf_file_id}return console.log(!content&&!pdf_upload),content||pdf_upload?{name:name,description:description,content:content,begin:begin,tags:tags,thoigian:time,is_file:is_file,file_id:file_id,questions:r()}:(toastr.warning("Bạn chưa nhập nội dung đề thi"),!1)}function r(){var t=[];return e(".ansRow").each(function(n){questionOrder=e(this).data("question-order"),givenAnswer=e('input[id^="answer_'+questionOrder+'_"][value=1]').attr("name"),givenAnswer=givenAnswer.substring(givenAnswer.length-1,givenAnswer.length),question={answer:givenAnswer.toUpperCase(),content:T.answerArray[n+1]?T.answerArray[n+1]:""},t.push(question)}),t}function l(){choiceDo(),w(),sticky()}function c(){e("#btn-add").on("click",function(t){t.preventDefault(),u(e("#total_add").val())}),e("#btn-remove").on("click",function(t){t.preventDefault(),p(e("#total_remove").val())}),e("#begin").on("keyup",function(){f()})}function d(){global.data.test?u(global.data.test.questionsCount,global.data.test.questions):u(5,!1)}function u(t,n){for(i=1;i<=t;i++)qIndex=e(".ansRow:last").data("question-order"),qIndex=qIndex?qIndex:0,dataNode=n?n[i-1]:!1,h(parseInt(qIndex)+1,dataNode);l(),g(),f()}function p(t){if(g()-parseInt(t)<1)return toastr.warning("Tổng số câu hỏi không được nhỏ hơn 1"),!1;for(qIndex=e(".ansRow:last").data("question-order"),toIndex=parseInt(qIndex)-parseInt(t),i=qIndex;i>toIndex;i--)e('tr[data-question-order="'+i+'"]').remove();g()}function h(t,n){selectedAnswer=!1,content=!1,answerd="",n&&(selectedAnswer=n.answer.toLowerCase(),content=n.content,answerd=" answered",content&&(T.answerArray[t]=content)),row='<tr class="ansRow'+answerd+'" data-question-order="'+t+'"><td align="center" class="questionNumber">'+t+".</td>",["a","b","c","d","e"].forEach(function(e){opchoice=selectedAnswer==e?" op-choice":"",value=selectedAnswer==e?1:0,hinted=content?" hinted":"",row+='<td><a id="a_'+t+"_"+e+'" rel="1" class="icontest-option op-'+e+opchoice+'"href="#"">'+e+'</a><input type="hidden" id="answer_'+t+"_"+e+'" name="answer_'+t+"_"+e+'" value="'+value+'"></td>'}),row+='<td><a href="javscript::void(0)" class="iconHint"><i class="zn-icon icon-hint'+hinted+'"></i></a></td></tr>',e("#answer>tbody").append(row)}function f(){val=e("#begin").val(),val=parseInt(val)>=1?parseInt(val):1,e(".questionNumber").each(function(t){e(this).html(parseInt(t)+val+".")})}function g(){return total=e(".ansRow").length,e("#total").html(total),total}function m(){return unanswered=e('.ansRow:not(".answered")').length,0!=unanswered&&toastr.warning("Bạn chưa điền đầy đủ đáp án cho các câu hỏi"),0==unanswered}function w(){e(".icon-hint").unbind("click"),e(".icon-hint").on("click",function(){qIndex=e(this).closest("tr").data("question-order"),hint=e("#answerModalArea"),icon=e(this),currentValue=T.answerArray[qIndex]?T.answerArray[qIndex]:"",hint.val(currentValue),questionNumber=parseInt(qIndex)+parseInt(_.begin.val())-1,e("#answerModal .modal-title").html("Gợi ý trả lời cho câu "+questionNumber),T.preventClose=!1,e("#answerModal").modal().on("hide.bs.modal",function(){T.preventClose=!0,T.answerArray[qIndex]=hint.val(),icon.removeClass("hinted"),hint.val()&&icon.addClass("hinted")})})}function v(){Dropzone.autoDiscover=!1,e("div#images-uploader").dropzone({url:"/api/v2/files",paramName:"file",headers:{"X-XSRF-Token":e('meta[name="csrf"]').attr("content")},maxFilesize:3,parallelUploads:1,acceptedFiles:"image/*",dictDefaultMessage:"Kéo và thả ảnh vào đây để upload",dictInvalidFileType:"Định dạng file không cho phép",init:function(){this.on("success",function(e,t){imgHTML="<img src='"+t.link+"' alt='"+t.original_filename+"'/>",_.content.editable("insertHTML",imgHTML,!0)}),this.on("error",function(e,t){validationError(t)})}}),e("div#pdf-uploader").dropzone({url:"/api/v2/files",paramName:"file",headers:{"X-XSRF-Token":e('meta[name="csrf"]').attr("content")},maxFilesize:10,parallelUploads:1,acceptedFiles:"application/pdf",dictDefaultMessage:"Kéo và thả file PDF vào đây<br>Kích thước tối đa 10MB",dictInvalidFileType:"Định dạng file không cho phép",dictResponseError:"abc",init:function(){this.on("success",function(e,t){b(t)}),this.on("error",function(e,t){validationError(t)})}}),e("div#close-uploader").on("click",function(){e(this).parent().slideUp()}),e("a#toggle-uploader").on("click",function(t){t.preventDefault(),e("div#images-uploader").slideToggle()})}function b(t){e("#pdf").html('<iframe width="100%" height="750px" src="http://hoidapyhoc.com/assets/pdfjs/web/viewer.html?file='+t.link+'"></iframe>'),global.pdf_file_id=t.id}function x(){_.content.editable({inlineMode:!0,alwaysVisible:!0,pasteImage:!0,pastedImagesUploadURL:"/api/v2/files/paste",maxImageSize:3145728,noFollow:!0,imageUploadURL:"/api/v2/files",defaultImageWidth:0,imageUploadParams:{type:"json"},headers:{"X-XSRF-Token":e('meta[name="csrf"]').attr("content")}}),e('a[href*="froala.com"]').closest("div").hide(),e("#select-tags").selectize({plugins:["remove_button"],valueField:"name",labelField:"name",searchField:"name",persist:!1,create:!0,maxItems:5,render:{option:function(e,t){return'<div><span class="post-tag">'+t(e.name)+'</span><span class="item-multiplier"><span class="item-multiplier-x">×</span>&nbsp;<span class="item-multiplier-count">'+e.count+"</span></span></div>"}},load:function(t,n){return t.length?void e.ajax({url:"/api/v2/tags/search/"+encodeURIComponent(t),type:"GET",error:function(){n()},success:function(e){n(e.data)}}):n()}})}function q(){window.onbeforeunload=function(e){return e=e||window.event,T.preventClose?(e&&(e.returnValue="Bạn có chắc chắn muốn thoát ? "),"Bạn có chắc chắn muốn thoát ? "):void 0}}function $(){width=parseInt(e(window).width()),width<=767&&e(".quiz-sidebar-section").css("max-height","100%").toggle()}function C(e){window.console.log(e)}e.fn.quiz=function(){switch(data=global.data,data.type){case"edit":n();break;case"create":t()}};var _={name:e("#input-name"),content:e("#content"),description:e("#input-description"),begin:e("#begin"),tag:e("#select-tags"),tabContent:e("#tab-content a"),adjustTotal:e("#adjustTotal"),answerTable:e("#answer"),btnCreateSubmit:e("#btnCreateSubmit")},T={postUrl:"/api/v2/exams",postAjaxMethod:"POST",answerArray:{},preventClose:!0}}(jQuery);